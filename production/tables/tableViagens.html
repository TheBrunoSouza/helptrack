<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Help Track | Gestor de Viagens </title>
  <link rel="icon" href="../images/imagens/16x16/veiculo.png">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <!-- Bootstrap -->
  <link href="../../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="../../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="../../vendors/nprogress/nprogress.css" rel="stylesheet">
  <!-- iCheck -->
  <link href="../../vendors/iCheck/skins/flat/green.css" rel="stylesheet">

  <!-- bootstrap-progressbar -->
  <link href="../../vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
  <!-- JQVMap -->
  <link href="../../vendors/jqvmap/dist/jqvmap.min.css" rel="stylesheet"/>
  <!-- bootstrap-daterangepicker -->
  <link href="../../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="../../vendors/jquery/dist/jquery.min.js"></script>

  <!-- DataTables CSS -->
  <link href="../../vendors/datatables-plugins/dataTables.bootstrap.css" rel="stylesheet" />
  <!-- DataTables Responsive CSS -->
  <link href="../../vendors/datatables-responsive/dataTables.responsive.css" rel="stylesheet" />

  <!-- DataTables JavaScript -->
  <script src="../../vendors/datatables/js/jquery.dataTables.min.js"></script>
  <script src="../../vendors/datatables-plugins/dataTables.bootstrap.min.js"></script>
  <script src="../../vendors/datatables-responsive/dataTables.responsive.js"></script>

  <!--Mapa Google-->
  <script src="../js/maps/markerclusterer.js"></script>
  <script src="../js/maps/markerwithlabel.js" async></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0oFYKDpD5zmMsUZJkJfv8SKiEu3JJ_ZA" async defer></script>

  <!-- Custom Theme Style -->
  <link href="../../build/css/custom.min.css" rel="stylesheet">

  <style type="text/css">
    html, body, #map-canvas {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map-canvas {
      width:860px;
      height:480px;
    }

    .labels {
      color: white;
      background-color: gray;
      font-family: "Lucida Grande", "Arial", sans-serif;
      font-size: 8px;
      text-align: center;
      width: 30px;
      white-space: nowrap;
    }

    .toolbar {
      float:left;
    }
  </style>

</head>

<body class="nav-md">
<div class="container body">
  <div class="main_container">
    <div class="col-md-3 left_col">
      <div class="left_col scroll-view">
        <div class="navbar nav_title" style="border: 0;">
          <a href="../index.html" class="site_title"><span>Help Track</span></a>
        </div>

        <div class="clearfix"></div>

        <!-- BEM VINDO -->
        <div class="profile clearfix">
          <div class="profile_pic">
            <img src="../images/perfil.jpg" alt="..." class="img-circle profile_img">
          </div>
          <div class="profile_info">
            <span>Bem vindo,</span>
            <h2>Bruno Souza</h2>
          </div>
        </div>

        <!-- MENU LATERAL -->
        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
          <div class="menu_section">
            <ul class="nav side-menu">
              <li><a><i class="fa fa-bar-chart"></i> Operação <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="../dashboard.html">Dashboard</a></li>
                  <li><a href="#">Mapa</a></li>
                </ul>
              </li>
              <li><a><i class="fa fa-cogs"></i> Manutenção <span class="fa fa-chevron-down"></span></a>
                <ul class="nav child_menu">
                  <li><a href="#">Condutores</a></li>
                  <li><a href="#">Veículos</a></li>
                  <li><a href="tableViagens.html">Viagens</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>

      </div>
    </div>

    <!-- top navigation -->
    <div class="top_nav">
      <div class="nav_menu">
        <nav>
          <div class="nav toggle">
            <a id="menu_toggle"><i class="fa fa-bars"></i></a>
          </div>

          <ul class="nav navbar-nav navbar-right">
            <li class="">
              <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                Sistema
                <span class=" fa fa-angle-down"></span>
              </a>
              <ul class="dropdown-menu dropdown-usermenu pull-right">
                <li><a href="#"> Seu Perfil</a></li>
                <li>
                  <a href="#">
                    <!--<span class="badge bg-red pull-right">50%</span>-->
                    <span>Configura&ccedil;&otilde;es</span>
                  </a>
                </li>
                <li><a href="#">Ajuda</a></li>
                <li><a href="#"><i class="fa fa-sign-out pull-right"></i> Sair</a></li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- /top navigation -->

    <!-- CONTAINER -->
    <div class="right_col" role="main">

      <!-- PANEL DE ATRASOS E RANKING -->
      <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="dashboard_graph">

                <button id="buttonNovaViagem" class="btn btn-primary" type="button" style="margin-left: 90%" onclick="novaViagem()">Nova Viagem</button>

            <!--ATRASOS-->
            <div class="row x_title">
              <div class="col-md-6">
                <h3>Viagens</h3>
              </div>
            </div>

            <div class="row">
              <div class="col-lg-12 col-xs-12">
                <table class="table table-striped table-bordered table-hover" id="idDataTablesViagem" style="width: 100%">
                  <thead>
                  <tr>
                    <th data-field="codViagem" title=codigo_viagem"></th>
                    <th data-field="placa" title="Ve&iacute;culo"> Ve&iacute;culo </th>
                    <th data-field="codReferenciaIni" title="Situa&ccedil;&atilde;o">Local Inicial</th>
                    <th data-field="codReferenciaFim" title="Alterar situação manualmente"> Local Final </th>
                    <th data-field="prevPartida" title="Previsão de início">Previs&atilde;o de Partida</th>
                    <th data-field="partida" title="Data de início">Partida</th>
                    <th data-field="prevChegada" title="Previsão de fim">Previs&atilde;o de Chegada</th>
                    <th data-field="chegada" title="Data de fim">Chegada</th>
                    <th data-field="status" title="Referência inicial"> Status</th>
                    <th data-field="situacao" title=Referência final> Situação </th>
                    <th data-field="descricao" title="Distância">Descri&ccedil;&atilde;o</th>
                    <th data-field="rota" title="rota">Rota</th>
                  </tr>
                  </thead>
                </table>
              </div>
            </div>

            <!-- PARTIDA -->
            <div class="modal fade" id="viagemMapModal" style="height: 800px;">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="">X</button>
                    <h4 class="modal-title">Posi&ccedil;&atilde;o Atual do Ve&iacute;culo</h4>
                  </div>
                  <div class="modal-body">
                    <div class="container">
                      <div class="row">
                        <!-- Na div abaixo é carregado um mapa do Google Maps através do Jquery -->
                        <div id="map-canvasPartida" class="" style="height: 400px;"></div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button id="buttonIniciarViagem" class="btn btn-primary" type="button" style="margin-left: 70%" onclick="iniciarViagem()">Iniciar</button>
                  </div>
                  <input type="text" id="codViagemIniciarHidden" hidden="true">
                </div>
              </div>
            </div>

            <!-- CHEGADA -->
            <div class="modal fade" id="chegadaModal" style="height: 800px;">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="">X</button>
                    <h4 class="modal-title">Posi&ccedil;&atilde;o Atual do Ve&iacute;culo</h4>
                  </div>
                  <div class="modal-body">
                    <div class="container">
                      <div class="row">
                        <!-- Na div abaixo é carregado um mapa do Google Maps através do Jquery -->
                        <div id="map-canvasChegada" class="" style="height: 400px;"></div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button id="buttonFinalizarViagem" class="btn btn-danger" type="button" style="margin-left: 70%" onclick="finalizarViagem()">Encerrar</button>
                  </div>
                  <input type="text" id="codViagemFinalizarHidden" hidden="true">
                </div>
              </div>
            </div>


            <div class="clearfix"></div>
          </div>
        </div>
      </div>
      <br>
    </div>
  </div>
</div>

<script type="text/javascript">

  function novaViagem(){
      window.location.href = "../cad/cadViagens.php";
  }

  function iniciarViagem(){
      $.ajax({
          type: 'post',
          url: '../exec/execViagem.php',
          data: {
              "acao": 'iniciarViagem',
              "codViagem": $('#codViagemIniciarHidden').val()
          },
          success: function () {
              alert ("Viagem Iniciada!");
              $('#viagemMapModal').modal('hide');
              location.reload();
          }
      });
  }

  function finalizarViagem(){
      $.ajax({
          type: 'post',
          url: '../exec/execViagem.php',
          data: {
              "acao": 'finalizarViagem',
              "codViagem": $('#codViagemFinalizarHidden').val()
          },
          success: function () {
              alert ("Viagem Finalizada!");
              $('#chegadaModal').modal('hide');
              location.reload();
          }
      });
  }

  $(document).ready(function() {

      var table = $('#idDataTablesViagem').DataTable({
          "order": [
              [ 8, "asc" ]
          ],
          "bJQueryUI": true,
          "oLanguage": {
              "sProcessing":   "Processando...",
              "sLengthMenu":   "Exibir _MENU_ registros",
              "sZeroRecords":  "Não foram encontrados resultados",
              "sInfo":         "Exibindo de _START_ até _END_ de _TOTAL_ registros",
              "sInfoEmpty":    "Exibindo de 0 até 0 de 0 registros",
              "sInfoFiltered": "",
              "sInfoPostFix":  "",
              "sSearch":       "Buscar:",
              "sUrl":          "",
              "oPaginate": {
                  "sFirst":    "Primeiro",
                  "sPrevious": "Anterior",
                  "sNext":     "Seguinte",
                  "sLast":     "Último"
              }
          },
          destroy: true,
          responsive: true,
          processing: true,
          oScroller: {
              "loadingIndicator": true
          },
          ajax: {
              url: '../json/jsonViagens.php',
              dataSrc: 'viagens'
          },
          columns: [
              { "data": "codViagem"},
              { "data": "placa" },
              { "data": "codReferenciaIni" },
              { "data": "codReferenciaFim" },
              { "data": "prevPartida" },
              {
                  //Partida
                  sortable: false,
                  "render": function (data, type, full, meta) {
                      if (full.partida == null) {
                          return "<button type='button' class='btn btn-primary btn-circle'data-target='#viagemMapModal' data-toggle='modal' data-viagem='"+full.codViagem+"'>" +
                              "<i class='fa fa-play'></i>" +
                              "</button>";
                      }
                      else {
                          return full.partida;
                      }
                  }
              },
              { "data": "prevChegada" },
              { "data": "chegada" },
              { "data": "statusViagem"},
              { "data": "situacaoViagem" },
              { "data": "descricaoViagem" },
              {
                  //Rota
                  sortable: false,
                  "render": function (data, type, full, meta) {
                      var disabled = 'disabled';
                      if(full.partida == null){
                          disabled = 'disabled'
                      }
                      var html = "<button type='button' "+disabled+" class='btn btn-primary btn-circle' data-toggle='modal' data-target='#viagemMapModal' data-placa='"+full.placa+"'>"+
                          "<i class='fa fa-map-marker'></i>"+
                          "</button>";
                      return (html);
                  }
              }
          ],
          //Cores de status
          "columnDefs": [
              {
                "targets": 8,
                "createdCell": function (td, cellData, rowData, row, col) {
                    var colorBackground = "";
                    var colorFont = "";
                    switch (rowData.codStatusViagem){
                        case '1':
                            colorBackground = '#ff4d4d';
                            colorFont = '#ffffff';
                            break;
                        case '2':
                            colorBackground = '#3399ff';
                            colorFont = '#333333'
                            break;
                        case '3':
                            colorBackground = '#ffb84d';
                            colorFont = '#333333';
                            break;
                    }
                    $(td).css('background-color', colorBackground);
                    $(td).css('color', colorFont);
                }
              },
              {
                  "targets": 9,
                  "createdCell": function (td, cellData, rowData, row, col) {
                      var colorFont = "";
                      switch (rowData.codSituacaoViagem){
                          case '1': //Finalizada
                              colorFont = '#1917ff';
                              break;
                          case '2': //Aguardando inicio
                              colorFont = '#fa9000'
                              break;
                          case '3': //Em Andamento
                              colorFont = '#49ff07';
                              break;
                      }
                      $(td).css('color', colorFont);
                  }
              }
          ,{
              //Chegada
              "targets": 7,
              "createdCell": function (td, cellData, rowData, row, col) {
                  var disabled = '';
                  if(rowData.partida == null){
                      disabled = 'disabled';
                  }
                  if(rowData.chegada == null){
                      $(td).html("<button type='button'  "+disabled +" class='btn btn-primary btn-circle' data-target='#chegadaModal' data-toggle='modal' data-viagem='"+rowData.codViagem+"'>"+
                          "<i class='fa fa-stop'></i>"+
                          "</button>");
                  }else{
                      $(td).html(rowData.chegada);
                  }
              }
          }],
      });

      //Atualizando a table viagens
      setInterval(function () {
          table.ajax.reload();
      }, 120000);

      //Criando o mapa
      $('#viagemMapModal').on('shown.bs.modal', function(e) {
          map = new google.maps.Map(document.getElementById('map-canvasPartida'), {
              center: {
                  lat: -22.397,
                  lng: -44.644
              },
              zoom: 6
          });

          //Limpa os marcadores em caso de abrir uma nova viagem
          //clearMarkers (null);

          $('#codViagemIniciarHidden').val(e.relatedTarget.dataset.viagem);
          console.info($('#codViagemIniciarHidden').val());

          var infowindow = new google.maps.InfoWindow();
          var marker;
          var line;
          var latLngOld = '';
          var image;
          var data = {
              placa: placa,
          };

          var posicaoFlag = "";
          var flag = 0;

          $.getJSON('../data/getRotaViagem.php', data, function(json1) {
              $.each(json1.positions, function(key, data) {
                  if(data.icon!='pinStart.png' && data.icon!='pin.png') {
                      image = {
                          url: '../images/map/'+data.icon,
                          origin: new google.maps.Point(0, 0),
                          anchor: new google.maps.Point(4, 4),
                          scaledSize: new google.maps.Size(8, 8)
                      };
                  }
                  else {
                      image = {
                          url: '../images/map/'+data.icon,
                          scaledSize: new google.maps.Size(35, 48)
                      }
                  }

                  var latLng = new google.maps.LatLng(data.lat, data.lon);
                  marker = new google.maps.Marker({
                      center:     location,
                      map:        map,
                      position:   latLng,
                      title:      data.placa,
                      icon : image
                  });
                  var details = "Placa: " + data.placa + "<br />" +
                      "Condutor: " + data.condutor + "<br />" +
                      "Data: " + data.data_hora + "<br />" +
                      "Vel.: " + data.velocidade;
                  bindInfoWindow(marker, map, infowindow, details);
                  markers.push(marker);

                  if(latLngOld != '') {
                      line = new google.maps.Polyline({
                          path: [latLng, latLngOld],
                          strokeOpacity: 0.8,
                          strokeWeight: 2,
                          strokeColor: '#f00',
                          geodesic: true,
                          map: map
                      });
                  }
                  latLngOld = latLng;

                  // centraliza o mapa na última latitude e longitude pesquisada
                  map.setCenter (latLng);

                  markers.push(marker);
              });

              image = {
                  url: '../images/map/pinEnd.png',
                  scaledSize: new google.maps.Size(35, 48)
              }
              marker.setIcon(image, marker);
              // var markerCluster = new MarkerClusterer(map, markers);

              $.each(json1.viagens, function(key, data) {

                  image = '../images/map/'+data.poi;

                  var latLng = new google.maps.LatLng(data.lat, data.lon);

                  marker = new MarkerWithLabel({
                      position: latLng,
                      raiseOnDrag: true,
                      map: map,
                      icon : image,

                      labelContent: data.ordemPrev+" | "+data.ordemExec,
                      labelAnchor: new google.maps.Point(10, 0),
                      labelClass: "labels" // the CSS class for the label
                  });

                  var details = "Referência: " + data.descRef + "<br />" +
                      "Prev. Ini.: " + data.prevIni + "<br />" +
                      "ID.: " + data.idPonto + "<br />" +
                      "Data Ini.: " + data.dtIni + "<br />" +
                      "Prev. Fim: " +data.prevFim + "<br />" +
                      "Data Fim: " + data.dtFim;
                  bindInfoWindow(marker, map, infowindow, details);
              });

              if (flag == 1) {
                  map.setZoom (13);
                  map.setCenter(latLng);
              }
          });

      });

      $('#chegadaModal').on('shown.bs.modal', function(e) {
          map = new google.maps.Map(document.getElementById('map-canvasChegada'), {
              center: {
                  lat: -22.397,
                  lng: -44.644
              },
              zoom: 6
          });

          //Limpa os marcadores em caso de abrir uma nova viagem
          //clearMarkers (null);

          $('#codViagemFinalizarHidden').val(e.relatedTarget.dataset.viagem);
          console.info($('#codViagemFinalizarHidden').val());
//
//          var infowindow = new google.maps.InfoWindow();
//          var marker;
//          var line;
//          var latLngOld = '';
//          var image;
//          var data = {
//              placa: placa,
//          };

//          var posicaoFlag = "";
//          var flag = 0;

//          $.getJSON('../data/getRotaViagem.php', data, function(json1) {
//              $.each(json1.positions, function(key, data) {
//                  if(data.icon!='pinStart.png' && data.icon!='pin.png') {
//                      image = {
//                          url: '../images/map/'+data.icon,
//                          origin: new google.maps.Point(0, 0),
//                          anchor: new google.maps.Point(4, 4),
//                          scaledSize: new google.maps.Size(8, 8)
//                      };
//                  }
//                  else {
//                      image = {
//                          url: '../images/map/'+data.icon,
//                          scaledSize: new google.maps.Size(35, 48)
//                      }
//                  }
//
//                  var latLng = new google.maps.LatLng(data.lat, data.lon);
//                  marker = new google.maps.Marker({
//                      center:     location,
//                      map:        map,
//                      position:   latLng,
//                      title:      data.placa,
//                      icon : image
//                  });
//                  var details = "Placa: " + data.placa + "<br />" +
//                      "Condutor: " + data.condutor + "<br />" +
//                      "Data: " + data.data_hora + "<br />" +
//                      "Vel.: " + data.velocidade;
//                  bindInfoWindow(marker, map, infowindow, details);
//                  markers.push(marker);
//
//                  if(latLngOld != '') {
//                      line = new google.maps.Polyline({
//                          path: [latLng, latLngOld],
//                          strokeOpacity: 0.8,
//                          strokeWeight: 2,
//                          strokeColor: '#f00',
//                          geodesic: true,
//                          map: map
//                      });
//                  }
//                  latLngOld = latLng;
//
//                  // centraliza o mapa na última latitude e longitude pesquisada
//                  map.setCenter (latLng);
//
//                  markers.push(marker);
//              });
//
//              image = {
//                  url: '../images/map/pinEnd.png',
//                  scaledSize: new google.maps.Size(35, 48)
//              }
//              marker.setIcon(image, marker);
//              // var markerCluster = new MarkerClusterer(map, markers);
//
//              $.each(json1.viagens, function(key, data) {
//
//                  image = '../images/map/'+data.poi;
//
//                  var latLng = new google.maps.LatLng(data.lat, data.lon);
//
//                  marker = new MarkerWithLabel({
//                      position: latLng,
//                      raiseOnDrag: true,
//                      map: map,
//                      icon : image,
//
//                      labelContent: data.ordemPrev+" | "+data.ordemExec,
//                      labelAnchor: new google.maps.Point(10, 0),
//                      labelClass: "labels" // the CSS class for the label
//                  });
//
//                  var details = "Referência: " + data.descRef + "<br />" +
//                      "Prev. Ini.: " + data.prevIni + "<br />" +
//                      "ID.: " + data.idPonto + "<br />" +
//                      "Data Ini.: " + data.dtIni + "<br />" +
//                      "Prev. Fim: " +data.prevFim + "<br />" +
//                      "Data Fim: " + data.dtFim;
//                  bindInfoWindow(marker, map, infowindow, details);
//              });
//
//              if (flag == 1) {
//                  map.setZoom (13);
//                  map.setCenter(latLng);
//              }
//          });

      });
  });
</script>

<!-- Bootstrap -->
<script src="../../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- FastClick -->
<script src="../../vendors/fastclick/lib/fastclick.js"></script>
<!-- NProgress -->
<script src="../../vendors/nprogress/nprogress.js"></script>
<!-- Chart.js -->
<script src="../../vendors/Chart.js/dist/Chart.min.js"></script>
<!-- gauge.js -->
<script src="../../vendors/gauge.js/dist/gauge.min.js"></script>
<!-- bootstrap-progressbar -->
<script src="../../vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
<!-- iCheck -->
<script src="../../vendors/iCheck/icheck.min.js"></script>
<!-- Skycons -->
<script src="../../vendors/skycons/skycons.js"></script>
<!-- Flot -->
<script src="../../vendors/Flot/jquery.flot.js"></script>
<script src="../../vendors/Flot/jquery.flot.pie.js"></script>
<script src="../../vendors/Flot/jquery.flot.time.js"></script>
<script src="../../vendors/Flot/jquery.flot.stack.js"></script>
<script src="../../vendors/Flot/jquery.flot.resize.js"></script>
<!-- Flot plugins -->
<script src="../../vendors/flot.orderbars/js/jquery.flot.orderBars.js"></script>
<script src="../../vendors/flot-spline/js/jquery.flot.spline.min.js"></script>
<script src="../../vendors/flot.curvedlines/curvedLines.js"></script>
<!-- DateJS -->
<script src="../../vendors/DateJS/build/date.js"></script>
<!-- JQVMap -->
<script src="../../vendors/jqvmap/dist/jquery.vmap.js"></script>
<script src="../../vendors/jqvmap/dist/maps/jquery.vmap.world.js"></script>
<script src="../../vendors/jqvmap/examples/js/jquery.vmap.sampledata.js"></script>
<!-- bootstrap-daterangepicker -->
<script src="../../vendors/moment/min/moment.min.js"></script>
<script src="../../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>

<!-- Custom Theme Scripts -->
<script src="../../build/js/custom.min.js"></script>

</body>
</html>
